<!-- Load js-yaml once near the top of <body> -->
<script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>

<style>
  .rule{padding:8px 10px;border-bottom:1px solid #eee;cursor:pointer}
  .rule strong{font-weight:600}
  .chip{display:inline-block;margin-left:8px;font-size:.72rem;padding:2px 6px;border-radius:999px;background:#eee}
  .chip-r{background:#fdecea}
  .chip-g{background:#eef7ee}
  #ruleDetails p{white-space:normal;line-height:1.5;margin:0 0 .75rem}
  .muted{color:#666}
  .small{font-size:.85rem;color:#555}
</style>

<script>
  const CH_ORDER = ['1','1A','3','5','6','7'];

  async function loadYamlArray(path){
    try{
      const res = await fetch(path, {cache:'no-store'});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();
      const y = jsyaml.load(text);
      if (Array.isArray(y)) return y;
      if (y && Array.isArray(y.rules)) return y.rules; // backward compat
      if (y && Array.isArray(y.items)) return y.items; // some generators
      return [];
    }catch(e){
      console.error('Failed to load', path, e);
      return [];
    }
  }

  function normalizeRule(r){
    // 1) If id ends with R/G, move into type
    const m = /^(\d+[A-Z]?\.\d+\.\d+(?:-[A-Z]|[A-Z])?)(R|G)$/.exec(r.id || '');
    if (m && !r.type){ r.id = m[1]; r.type = m[2]; }
    // 2) Clean/complete fields
    r.type = (r.type === 'R' ? 'R' : 'G');
    r.title = (r.title || '').replace(/^(R|G)\s+/, ''); // remove leading R/G if present
    r.display = r.display || `CASS ${r.id}`;
    r.text = r.text || '';
    r.chapter = r.chapter || (r.id ? r.id.split('.')[0] : '');
    return r;
  }

  function chapterOrderKey(rule){
    const ch = rule.chapter || rule.id.split('.')[0];
    const chIdx = CH_ORDER.includes(ch) ? CH_ORDER.indexOf(ch) : 99;
    const [c,s,r] = (rule.id || '0.0.0').split('.');
    const sec = parseInt(s,10)||0;
    const rnum = parseInt((r||'').replace(/[^0-9]/g,''),10)||0;
    const rsuf = (r||'').replace(/[0-9]/g,'');
    const typeRank = rule.type === 'R' ? 0 : 1;
    return [chIdx, c, sec, rnum, rsuf, typeRank];
  }

  function escapeHtml(s){
    return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function textToHtml(text){
    if (!text) return '<p class="muted">No text.</p>';
    // Treat double newlines as paragraph breaks; single newlines → spaces
    const paras = text.split(/\n{2,}/).map(p => p.replace(/\n/g, ' ').trim()).filter(Boolean);
    return paras.map(p => `<p>${escapeHtml(p)}</p>`).join('');
  }

  function renderRuleList(list){
    const wrap = document.getElementById('ruleList');
    wrap.innerHTML = '';
    list.forEach((r, idx) => {
      const el = document.createElement('div');
      el.className = 'rule';
      el.dataset.idx = idx;
      el.innerHTML = `
        <strong>${escapeHtml(r.display)}</strong>${r.title ? ' — ' + escapeHtml(r.title) : ''}
        <span class="chip ${r.type==='R'?'chip-r':'chip-g'}">${r.type}</span>`;
      el.onclick = () => showRule(r);
      wrap.appendChild(el);
    });
  }

  function showRule(rule){
    const d = document.getElementById('ruleDetails');
    d.innerHTML = `
      <h4>${escapeHtml(rule.display)}${rule.title ? ' — ' + escapeHtml(rule.title) : ''}</h4>
      ${textToHtml(rule.text)}
    `;
  }

  (async function init(){
    // 1) Load rules
    const raw = await loadYamlArray('data/rules.yaml');
    let rules = raw.map(normalizeRule).sort((a,b) => {
      const A = chapterOrderKey(a), B = chapterOrderKey(b);
      return A < B ? -1 : A > B ? 1 : 0;
    });

    // 2) Defensive: if empty, tell the user instead of failing silently
    if (!rules.length){
      document.getElementById('ruleList').innerHTML =
        '<div class="muted">No rules loaded. Check <code>docs/data/rules.yaml</code> is present and non-empty.</div>';
      return;
    }

    // 3) Keep a global for debugging, render list, and show the first rule
    window._rules = rules;
    renderRuleList(rules);
    showRule(rules[0]);
  })();
</script>
